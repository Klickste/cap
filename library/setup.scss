/*===============================
=            Modules            =
===============================*/

@use 'sass:map';
@use 'sass:math';
@use 'sass:list';
@use 'sass:string';
@use 'sass:meta';
@use './config';
@use './utils';

/*=================================
=            Variables            =
=================================*/

/**
 *
 * Description...
 *
 */

$scales: ();

/**
 *
 * Description...
 *
 */

@each $baseSize in config.$baseSizes {
  $scaleIndex: list.index(config.$baseSizes, $baseSize);
  $sizes: ();

  @for $sizeIndex from (config.$downScales * -1) to (config.$upScales + 1) {
    $sizeName: list.nth(list.nth(config.$sizeKeys, config.$baseSizeIndex + $sizeIndex), 1);
    $fontSize: utils.getFontSize($baseSize, config.$scaleFactor, $sizeIndex);
    $lineHeight: utils.getLineHeight($fontSize);
    $sizes: map.merge(
      $sizes,
      (
        '#{$sizeName}': (
          'fontSize': $fontSize,
          'lineHeight': $lineHeight,
        ),
      )
    );
  }

  $scales: list.append($scales, $sizes);
}

/*==============================
=            Mixins            =
==============================*/

/**
 *
 * Description...
 *
 */

@mixin declareSizes($scale) {
  @each $sizeKey, $sizeProps in $scale {
    $sizeName: map.get(config.$sizeKeys, $sizeKey);
    $fontSize: map.get($sizeProps, 'fontSize');
    $lineHeight: map.get($sizeProps, 'lineHeight');

    --cap-fontSize-#{$sizeName}: #{$fontSize};
    --cap-lineHeight-#{$sizeName}: #{$lineHeight};

    @each $fontName, $fontProps in config.$fonts {
      $letterSpacingFactor: map.get($fontProps, 'spacing');
      $letterSpacing: if(
        $letterSpacingFactor != null,
        utils.getLetterSpacing($fontSize, $letterSpacingFactor),
        normal
      );

      /* FIXME: single 'normal' output for $letterSpacingFactor == null */
      --cap-letterSpacing-#{$sizeName}-#{$fontName}: #{$letterSpacing};

      @if config.$trim {
        $upm: map.get($fontProps, 'upm');
        $capHeight: map.get($fontProps, 'capHeight');
        $offset: utils.getOffset($fontSize, $lineHeight, $upm, $capHeight);

        --cap-offset-#{$sizeName}-#{$fontName}: #{$offset};
      }
    }
  }
}

/*=============================
=            Rules            =
=============================*/

/**
 *
 * Description...
 *
 */

@each $fontName, $fontProps in config.$fonts {
  $fontFamily: map.get($fontProps, 'family');
  $fontStyles: map.get($fontProps, 'styles');
  $fontWeights: map.get($fontProps, 'weights');
  $fontWeightsValues: map.values($fontWeights);
  $fontWeightMin: math.min($fontWeightsValues...);
  $fontWeightMax: math.max($fontWeightsValues...);

  @if $fontStyles != null {
    @each $fontStyle in $fontStyles {
      @font-face {
        $fontWeight: if(
          list.length($fontStyle) == 2,
          $fontWeightMin $fontWeightMax,
          list.nth($fontStyle, 3)
        );

        font-display: swap;
        font-family: string.unquote($fontFamily);
        font-style: string.unquote(list.nth($fontStyle, 1));
        font-weight: $fontWeight;
        src: url(list.nth($fontStyle, 2)) format('woff2');
      }
    }
  }
}

#{config.$root} {
  /**
   *
   * Description...
   *
   */

  @each $fontName, $fontProps in config.$fonts {
    $fontFamily: map.get($fontProps, 'family');
    $fontFamilyFallback: if(
      map.has-key($fontProps, 'fallback'),
      map.get($fontProps, 'fallback'),
      null
    );
    $fontFeatureSettings: map.get($fontProps, 'features');

    --cap-fontFamily-#{$fontName}: #{$fontFamily +
      if($fontFamilyFallback, ', #{$fontFamilyFallback}', '')};
    --cap-fontFeatureSettings-#{$fontName}: #{$fontFeatureSettings};

    @each $fontWeightName, $fontWeight in map.get($fontProps, 'weights') {
      --cap-fontWeight-#{$fontWeightName}-#{$fontName}: #{$fontWeight};
    }
  }

  /**
   *
   * Description...
   *
   */

  @each $scale in $scales {
    $index: list.index($scales, $scale);

    @if $index > 1 {
      @media (pointer: coarse) {
        @include declareSizes($scale);
      }
    } @else {
      @include declareSizes($scale);
    }
  }
}
